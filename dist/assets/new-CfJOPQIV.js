import{r as c,aF as ne,u as oe,b as e,a4 as m,a5 as W,j as l,a3 as b,a6 as _,a7 as $,a8 as z,aK as ae,ad as P,l as G,ab as x,a as R}from"./index-C3nL3Q8Y.js";import{A as M}from"./Alert-ByAO8-9K.js";import{C as ie}from"./Card-BM1iOIYZ.js";import{C as le}from"./CardContent-DB49xfDB.js";import{G as f}from"./Grid-4PTbkvA0.js";import{M as k}from"./MenuItem-NIEDGLUA.js";import{B as g}from"./Button-Dg9Z3r8Z.js";import{S as H,M as J,C as ce}from"./Stop-Dwyas6uG.js";import{D as B}from"./Delete-CuAI51Yz.js";import{A as ue}from"./Add-DzKt5l_V.js";import"./Close-ChL254u0.js";import"./listItemTextClasses-B7Ux6p96.js";const be=({editMode:p=!1})=>{const[n,h]=c.useState({questionText:"",questionType:"written",level:"",answers:[{text:"",isCorrect:!1,audioUrl:""},{text:"",isCorrect:!1,audioUrl:""}]}),[q,K]=c.useState([]),[V,X]=c.useState(!0),[i,w]=c.useState({question:null,answers:{}}),[A,U]=c.useState(null),[I,j]=c.useState(!1),[L,v]=c.useState(""),[D,F]=c.useState(""),C=c.useRef(null),S=c.useRef([]),{id:y}=ne(),Y=oe();c.useEffect(()=>{(async()=>{try{const t=await R.get("https://edunova-back-rqxc.onrender.com/api/level");K(t.data.data),!p&&t.data.data.length>0&&h(s=>({...s,level:t.data.data[0]._id}))}catch{v("Erreur lors du chargement des niveaux")}finally{X(!1)}})()},[p]),c.useEffect(()=>{p&&y&&q.length>0&&(async()=>{var t,s;try{const a=(await R.get(`https://edunova-back-rqxc.onrender.com/api/questions/${y}`)).data;h({questionText:a.questionText||"",questionType:a.questionType,level:a.level._id||a.level,answers:a.answers.map(d=>({text:d.text||"",isCorrect:d.isCorrect||!1,audioUrl:d.audioUrl||""}))});const u={};a.answers.forEach((d,T)=>{d.audioUrl&&(u[T]=d.audioUrl)}),w({question:a.audioUrl||null,answers:u})}catch(o){v(((s=(t=o.response)==null?void 0:t.data)==null?void 0:s.message)||o.message)}})()},[p,y,q]);const Q=async(r,t=null)=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new MediaRecorder(s);C.current=o,S.current=[],o.ondataavailable=a=>{S.current.push(a.data)},o.onstop=()=>{const a=new Blob(S.current,{type:"audio/wav"});w(r==="question"?u=>({...u,question:a}):u=>({...u,answers:{...u.answers,[t]:a}}))},o.start(),U(r==="question"?"question":t)}catch{v("Permission microphone refusée")}},N=()=>{C.current&&A!==null&&(C.current.stop(),C.current.stream.getTracks().forEach(r=>r.stop()),U(null))},E=r=>{const{name:t,value:s}=r.target;h(o=>({...o,[t]:s}))},Z=(r,t)=>{const s=[...n.answers];s[r].text=t,h(o=>({...o,answers:s}))},ee=r=>{const t=n.answers.map((s,o)=>({...s,isCorrect:o===r}));h(s=>({...s,answers:t}))},te=()=>{n.answers.length<4&&h(r=>({...r,answers:[...r.answers,{text:"",isCorrect:!1,audioUrl:""}]}))},re=r=>{if(n.answers.length>2){const t=[...n.answers];t.splice(r,1),h(o=>({...o,answers:t}));const s={...i.answers};delete s[r],w(o=>({...o,answers:s}))}},O=(r,t=null)=>{if(r==="question")w(s=>({...s,question:null}));else{const s={...i.answers};delete s[t],w(o=>({...o,answers:s}))}},se=async r=>{var t,s;r.preventDefault(),j(!0),v(""),F("");try{if(!n.questionType||!n.level)throw new Error("Type et niveau sont requis");if(n.questionType==="written"&&!n.questionText.trim())throw new Error("Texte de question requis pour les questions écrites");if(n.questionType==="oral"&&!i.question)throw new Error("Enregistrement audio requis pour les questions orales");if(n.answers.filter(d=>d.isCorrect).length!==1)throw new Error("Sélectionnez exactement une réponse correcte");const a=new FormData;a.append("questionText",n.questionText),a.append("questionType",n.questionType),a.append("level",n.level),a.append("answers",JSON.stringify(n.answers)),n.questionType==="oral"&&(i.question instanceof Blob&&a.append("questionAudio",i.question,"question.wav"),Object.entries(i.answers).forEach(([d,T])=>{T instanceof Blob&&a.append("answerAudios",T,`answer-${d}.wav`)}));let u;p&&y?u=await R.put(`https://edunova-back-rqxc.onrender.com/api/questions/${y}`,a,{headers:{"Content-Type":"multipart/form-data"}}):u=await R.post("https://edunova-back-rqxc.onrender.com/api/questions",a,{headers:{"Content-Type":"multipart/form-data"}}),F(p?"Question mise à jour avec succès!":"Question créée avec succès!"),setTimeout(()=>Y("/dashboard/contacts"),2e3)}catch(o){v(((s=(t=o.response)==null?void 0:t.data)==null?void 0:s.message)||o.message)}finally{j(!1)}};return V?e(m,{display:"flex",justifyContent:"center",mt:5,children:e(W,{})}):l(m,{m:"20px",children:[e(b,{variant:"h4",gutterBottom:!0,children:p?"Modifier la Question":"Créer une Nouvelle Question"}),L&&e(M,{severity:"error",sx:{mb:3},children:L}),D&&e(M,{severity:"success",sx:{mb:3},children:D}),e(ie,{children:e(le,{children:e("form",{onSubmit:se,children:l(f,{container:!0,spacing:3,children:[e(f,{item:!0,xs:12,md:6,children:l(_,{fullWidth:!0,children:[e($,{children:"Type de question"}),l(z,{name:"questionType",value:n.questionType,onChange:E,label:"Type de question",required:!0,children:[e(k,{value:"written",children:"Écrite"}),e(k,{value:"oral",children:"Orale"})]})]})}),e(f,{item:!0,xs:12,md:6,children:l(_,{fullWidth:!0,children:[e($,{children:"Niveau"}),e(z,{name:"level",value:n.level,onChange:E,label:"Niveau",required:!0,disabled:q.length===0,children:q.map(r=>e(k,{value:r._id,children:r.name},r._id))}),q.length===0&&e(ae,{error:!0,children:"Aucun niveau disponible"})]})}),n.questionType==="written"&&e(f,{item:!0,xs:12,children:e(P,{fullWidth:!0,label:"Texte de la question",name:"questionText",value:n.questionText,onChange:E,multiline:!0,rows:3,required:!0})}),n.questionType==="oral"&&l(f,{item:!0,xs:12,children:[e(b,{variant:"subtitle1",gutterBottom:!0,children:"Enregistrement de la question"}),l(m,{display:"flex",alignItems:"center",gap:2,children:[A==="question"?e(g,{variant:"contained",color:"error",startIcon:e(H,{}),onClick:N,children:"Arrêter"}):e(g,{variant:"contained",startIcon:e(J,{}),onClick:()=>Q("question"),children:i.question?"Réenregistrer":"Enregistrer"}),i.question&&l(G,{children:[e("audio",{controls:!0,src:i.question instanceof Blob?URL.createObjectURL(i.question):i.question}),e(x,{color:"error",onClick:()=>O("question"),children:e(B,{})})]})]})]}),l(f,{item:!0,xs:12,children:[e(b,{variant:"subtitle1",gutterBottom:!0,children:"Réponses (sélectionnez la réponse correcte)"}),n.answers.map((r,t)=>l(m,{sx:{mb:3,p:2,border:"1px solid #ddd",borderRadius:1},children:[l(m,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1,children:[l(m,{display:"flex",alignItems:"center",children:[e(x,{onClick:()=>ee(t),color:r.isCorrect?"success":"default",children:e(ce,{})}),e(b,{children:r.isCorrect?"Réponse correcte":"Marquer comme correcte"})]}),n.answers.length>2&&e(x,{color:"error",onClick:()=>re(t),children:e(B,{})})]}),n.questionType==="written"&&e(P,{fullWidth:!0,value:r.text,onChange:s=>Z(t,s.target.value),placeholder:`Réponse ${t+1}`,required:!0}),n.questionType==="oral"&&l(m,{display:"flex",alignItems:"center",gap:2,mt:1,children:[A===t?e(g,{variant:"contained",color:"error",startIcon:e(H,{}),onClick:N,children:"Arrêter"}):e(g,{variant:"contained",startIcon:e(J,{}),onClick:()=>Q("answer",t),children:i.answers[t]?"Réenregistrer":"Enregistrer"}),i.answers[t]&&l(G,{children:[e("audio",{controls:!0,src:i.answers[t]instanceof Blob?URL.createObjectURL(i.answers[t]):i.answers[t]}),e(x,{color:"error",onClick:()=>O("answer",t),children:e(B,{})})]})]})]},t)),n.answers.length<4&&e(g,{variant:"outlined",startIcon:e(ue,{}),onClick:te,children:"Ajouter une réponse"})]}),e(f,{item:!0,xs:12,children:e(g,{type:"submit",variant:"contained",color:"primary",disabled:I,startIcon:I?e(W,{size:20}):null,children:I?"Envoi en cours...":p?"Mettre à jour":"Créer"})})]})})})})]})};export{be as default};

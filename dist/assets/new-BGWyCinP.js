import{r as l,aF as ne,u as oe,b as e,a4 as h,a5 as W,j as c,a3 as T,a6 as _,a7 as $,a8 as z,aK as ae,ad as P,l as G,ab as x,a as R}from"./index-B07QrE09.js";import{A as M}from"./Alert-DACpG7Jo.js";import{C as ie}from"./Card-D2GAe7H9.js";import{C as ce}from"./CardContent-DA501-tu.js";import{G as f}from"./Grid-Dh9q74HS.js";import{M as E}from"./MenuItem-DDUDt6RG.js";import{B as q}from"./Button-C2CxUlaZ.js";import{S as H,M as J,C as le}from"./Stop-CPa1di5h.js";import{D as B}from"./Delete-CNWvXOXJ.js";import{A as ue}from"./Add-CsDwjOE3.js";import"./Close-C0eU_P1Q.js";import"./listItemTextClasses-N2EmFEEp.js";const Te=({editMode:p=!1})=>{const[n,m]=l.useState({questionText:"",questionType:"written",level:"",answers:[{text:"",isCorrect:!1,audioUrl:""},{text:"",isCorrect:!1,audioUrl:""}]}),[g,K]=l.useState([]),[V,X]=l.useState(!0),[i,w]=l.useState({question:null,answers:{}}),[A,U]=l.useState(null),[I,j]=l.useState(!1),[L,v]=l.useState(""),[D,F]=l.useState(""),C=l.useRef(null),S=l.useRef([]),{id:y}=ne(),Y=oe();l.useEffect(()=>{(async()=>{try{const r=await R.get("https://edunova-back-rqxc.onrender.com/api/level");K(r.data.data),!p&&r.data.data.length>0&&m(s=>({...s,level:r.data.data[0]._id}))}catch{v("Erreur lors du chargement des niveaux")}finally{X(!1)}})()},[p]),l.useEffect(()=>{p&&y&&g.length>0&&(async()=>{var r,s;try{const a=(await R.get(`https://edunova-back-rqxc.onrender.com/api/questions/${y}`)).data;m({questionText:a.questionText||"",questionType:a.questionType,level:a.level._id||a.level,answers:a.answers.map(d=>({text:d.text||"",isCorrect:d.isCorrect||!1,audioUrl:d.audioUrl||""}))});const u={};a.answers.forEach((d,b)=>{d.audioUrl&&(u[b]=d.audioUrl)}),w({question:a.audioUrl||null,answers:u})}catch(o){v(((s=(r=o.response)==null?void 0:r.data)==null?void 0:s.message)||o.message)}})()},[p,y,g]);const Q=async(t,r=null)=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new MediaRecorder(s);C.current=o,S.current=[],o.ondataavailable=a=>{S.current.push(a.data)},o.onstop=()=>{const a=new Blob(S.current,{type:"audio/wav"});w(t==="question"?u=>({...u,question:a}):u=>({...u,answers:{...u.answers,[r]:a}}))},o.start(),U(t==="question"?"question":r)}catch{v("Permission microphone refusée")}},N=()=>{C.current&&A!==null&&(C.current.stop(),C.current.stream.getTracks().forEach(t=>t.stop()),U(null))},k=t=>{const{name:r,value:s}=t.target;m(o=>({...o,[r]:s}))},Z=(t,r)=>{const s=[...n.answers];s[t].text=r,m(o=>({...o,answers:s}))},ee=t=>{const r=n.answers.map((s,o)=>({...s,isCorrect:o===t}));m(s=>({...s,answers:r}))},re=()=>{n.answers.length<4&&m(t=>({...t,answers:[...t.answers,{text:"",isCorrect:!1,audioUrl:""}]}))},te=t=>{if(n.answers.length>2){const r=[...n.answers];r.splice(t,1),m(o=>({...o,answers:r}));const s={...i.answers};delete s[t],w(o=>({...o,answers:s}))}},O=(t,r=null)=>{if(t==="question")w(s=>({...s,question:null}));else{const s={...i.answers};delete s[r],w(o=>({...o,answers:s}))}},se=async t=>{var r,s;t.preventDefault(),j(!0),v(""),F("");try{if(!n.questionType||!n.level)throw new Error("Type et niveau sont requis");if(n.questionType==="written"&&!n.questionText.trim())throw new Error("Texte de question requis pour les questions écrites");if(n.questionType==="oral"&&!i.question)throw new Error("Enregistrement audio requis pour les questions orales");if(n.answers.filter(d=>d.isCorrect).length!==1)throw new Error("Sélectionnez exactement une réponse correcte");const a=new FormData;a.append("questionText",n.questionText),a.append("questionType",n.questionType),a.append("level",n.level),a.append("answers",JSON.stringify(n.answers)),n.questionType==="oral"&&(i.question instanceof Blob&&a.append("questionAudio",i.question,"question.wav"),Object.entries(i.answers).forEach(([d,b])=>{b instanceof Blob&&a.append("answerAudios",b,`answer-${d}.wav`)}));let u;p&&y?u=await R.put(`https://edunova-back-rqxc.onrender.com/api/questions/${y}`,a,{headers:{"Content-Type":"multipart/form-data"}}):u=await R.post("https://edunova-back-rqxc.onrender.com/api/questions",a,{headers:{"Content-Type":"multipart/form-data"}}),F(p?"Question mise à jour avec succès!":"Question créée avec succès!"),setTimeout(()=>Y("/dashboard/contacts"),2e3)}catch(o){v(((s=(r=o.response)==null?void 0:r.data)==null?void 0:s.message)||o.message)}finally{j(!1)}};return V?e(h,{display:"flex",justifyContent:"center",mt:5,children:e(W,{})}):c(h,{m:"20px",children:[e(T,{variant:"h4",gutterBottom:!0,children:p?"Modifier la Question":"Créer une Nouvelle Question"}),L&&e(M,{severity:"error",sx:{mb:3},children:L}),D&&e(M,{severity:"success",sx:{mb:3},children:D}),e(ie,{children:e(ce,{children:e("form",{onSubmit:se,children:c(f,{container:!0,spacing:3,children:[e(f,{item:!0,xs:12,md:6,children:c(_,{fullWidth:!0,children:[e($,{children:"Type de question"}),c(z,{name:"questionType",value:n.questionType,onChange:k,label:"Type de question",required:!0,children:[e(E,{value:"written",children:"Écrite"}),e(E,{value:"oral",children:"Orale"})]})]})}),e(f,{item:!0,xs:12,md:6,children:c(_,{fullWidth:!0,children:[e($,{children:"Niveau"}),e(z,{name:"level",value:n.level,onChange:k,label:"Niveau",required:!0,disabled:g.length===0,children:g.map(t=>e(E,{value:t._id,children:t.name},t._id))}),g.length===0&&e(ae,{error:!0,children:"Aucun niveau disponible"})]})}),n.questionType==="written"&&e(f,{item:!0,xs:12,children:e(P,{fullWidth:!0,label:"Texte de la question",name:"questionText",value:n.questionText,onChange:k,multiline:!0,rows:3,required:!0})}),n.questionType==="oral"&&c(f,{item:!0,xs:12,children:[e(T,{variant:"subtitle1",gutterBottom:!0,children:"Enregistrement de la question"}),c(h,{display:"flex",alignItems:"center",gap:2,children:[A==="question"?e(q,{variant:"contained",color:"error",startIcon:e(H,{}),onClick:N,children:"Arrêter"}):e(q,{variant:"contained",startIcon:e(J,{}),onClick:()=>Q("question"),children:i.question?"Réenregistrer":"Enregistrer"}),i.question&&c(G,{children:[e("audio",{controls:!0,src:i.question instanceof Blob?URL.createObjectURL(i.question):i.question}),e(x,{color:"error",onClick:()=>O("question"),children:e(B,{})})]})]})]}),c(f,{item:!0,xs:12,children:[e(T,{variant:"subtitle1",gutterBottom:!0,children:"Réponses (sélectionnez la réponse correcte)"}),n.answers.map((t,r)=>c(h,{sx:{mb:3,p:2,border:"1px solid #ddd",borderRadius:1},children:[c(h,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1,children:[c(h,{display:"flex",alignItems:"center",children:[e(x,{onClick:()=>ee(r),color:t.isCorrect?"success":"default",children:e(le,{})}),e(T,{children:t.isCorrect?"Réponse correcte":"Marquer comme correcte"})]}),n.answers.length>2&&e(x,{color:"error",onClick:()=>te(r),children:e(B,{})})]}),n.questionType==="written"&&e(P,{fullWidth:!0,value:t.text,onChange:s=>Z(r,s.target.value),placeholder:`Réponse ${r+1}`,required:!0}),n.questionType==="oral"&&c(h,{display:"flex",alignItems:"center",gap:2,mt:1,children:[A===r?e(q,{variant:"contained",color:"error",startIcon:e(H,{}),onClick:N,children:"Arrêter"}):e(q,{variant:"contained",startIcon:e(J,{}),onClick:()=>Q("answer",r),children:i.answers[r]?"Réenregistrer":"Enregistrer"}),i.answers[r]&&c(G,{children:[e("audio",{controls:!0,src:i.answers[r]instanceof Blob?URL.createObjectURL(i.answers[r]):i.answers[r]}),e(x,{color:"error",onClick:()=>O("answer",r),children:e(B,{})})]})]})]},r)),n.answers.length<4&&e(q,{variant:"outlined",startIcon:e(ue,{}),onClick:re,children:"Ajouter une réponse"})]}),e(f,{item:!0,xs:12,children:e(q,{type:"submit",variant:"contained",color:"primary",disabled:I,startIcon:I?e(W,{size:20}):null,children:I?"Envoi en cours...":p?"Mettre à jour":"Créer"})})]})})})})]})};export{Te as default};

import{b as l,i as ne,u as re}from"./vendor-gGFwV6Yc.js";import{b as e,a0 as q,a1 as oe,j as u,$ as D,a9 as F,a2 as O,a3 as Q,a4 as $,a7 as C,a as T}from"./index-CNYIw3Ap.js";import{A as P}from"./Alert-BWUQE-b0.js";import{C as W}from"./Card-BV5SPX1h.js";import{C as N}from"./CardContent-B6nDGSXF.js";import{M as R}from"./MenuItem-Cq1GJlgR.js";import{B as v}from"./Button-q5rqdzgK.js";import{S as _,M as G,C as ae}from"./Stop-CxP14ki6.js";import{D as S}from"./Delete-C9pbEacl.js";import{G as f}from"./Grid-BM4MDois.js";import"./Close-B0rgw4hC.js";import"./listItemTextClasses-DelaPf-g.js";const ge=()=>{const[o,m]=l.useState({questionText:"",questionType:"written",level:"",answers:[{text:"",isCorrect:!1,audioUrl:""},{text:"",isCorrect:!1,audioUrl:""}]}),[J,z]=l.useState([]),[H,K]=l.useState(!0),[i,p]=l.useState({question:null,answers:{}}),[h,k]=l.useState(null),[E,U]=l.useState(!1),[A,w]=l.useState(""),[I,j]=l.useState(""),g=l.useRef(null),x=l.useRef([]),{id:b}=ne(),V=re();l.useEffect(()=>{(async()=>{try{const t=await T.get("https://edunova-back-rqxc.onrender.com/api/level");z(t.data.data)}catch{w("Erreur lors du chargement des niveaux")}finally{K(!1)}})()},[]),l.useEffect(()=>{b&&(async()=>{var t,n;try{const r=await T.get(`https://edunova-back-rqxc.onrender.com/api/questions/${b}`);console.log("Résultat API :",r.data);const a=r.data;m({questionText:a.questionText||"",questionType:a.questionType,level:typeof a.level=="object"?a.level._id:a.level||"",answers:a.answers.map(d=>({text:d.text||"",isCorrect:d.isCorrect||!1,audioUrl:d.audioUrl||""}))});const c={};a.answers.forEach((d,se)=>{d.audioUrl&&(c[se]=d.audioUrl)}),p({question:a.audioUrl||null,answers:c})}catch(r){w(((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||r.message)}})()},[b]);const B=async(s,t=null)=>{try{const n=await navigator.mediaDevices.getUserMedia({audio:!0}),r=new MediaRecorder(n);g.current=r,x.current=[],r.ondataavailable=a=>x.current.push(a.data),r.onstop=()=>{const a=new Blob(x.current,{type:"audio/wav"});p(s==="question"?c=>({...c,question:a}):c=>({...c,answers:{...c.answers,[t]:a}}))},r.start(),k(s==="question"?"question":t)}catch{w("Permission microphone refusée")}},L=()=>{g.current&&h!==null&&(g.current.stop(),g.current.stream.getTracks().forEach(s=>s.stop()),k(null))},y=s=>{const{name:t,value:n}=s.target;m(r=>({...r,[t]:n}))},X=(s,t)=>{const n=[...o.answers];n[s].text=t,m(r=>({...r,answers:n}))},Y=s=>{const t=o.answers.map((n,r)=>({...n,isCorrect:r===s}));m(n=>({...n,answers:t}))},Z=()=>{o.answers.length<4&&m(s=>({...s,answers:[...s.answers,{text:"",isCorrect:!1,audioUrl:""}]}))},ee=s=>{if(o.answers.length>2){const t=[...o.answers];t.splice(s,1);const n={...i.answers};delete n[s],m(r=>({...r,answers:t})),p(r=>({...r,answers:n}))}},M=(s,t=null)=>{if(s==="question")p(n=>({...n,question:null}));else{const n={...i.answers};delete n[t],p(r=>({...r,answers:n}))}},te=async s=>{var t,n;s.preventDefault(),U(!0),w(""),j("");try{if(!o.questionType||!o.level)throw new Error("Type et niveau requis");if(o.questionType==="written"&&!o.questionText.trim())throw new Error("Texte requis pour les questions écrites");if(o.questionType==="oral"&&!i.question)throw new Error("Audio requis pour les questions orales");if(o.answers.filter(c=>c.isCorrect).length!==1)throw new Error("Exactement une réponse correcte doit être sélectionnée");const a=new FormData;a.append("questionText",o.questionText),a.append("questionType",o.questionType),a.append("level",o.level),a.append("answers",JSON.stringify(o.answers)),o.questionType==="oral"&&(i.question instanceof Blob&&a.append("questionAudio",i.question,"question.wav"),Object.entries(i.answers).forEach(([c,d])=>{d instanceof Blob&&a.append("answerAudios",d,`answer-${c}.wav`)})),await T.put(`https://edunova-back-rqxc.onrender.com/api/questions/${b}`,a,{headers:{"Content-Type":"multipart/form-data"}}),j("Question mise à jour avec succès!"),setTimeout(()=>V("/dashboard/questions"),2e3)}catch(r){w(((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||r.message)}finally{U(!1)}};return H?e(q,{display:"flex",justifyContent:"center",mt:5,children:e(oe,{})}):u(q,{m:3,children:[e(D,{variant:"h4",gutterBottom:!0,children:"Modifier la Question"}),A&&e(P,{severity:"error",sx:{mb:2},children:A}),I&&e(P,{severity:"success",sx:{mb:2},children:I}),u("form",{onSubmit:te,children:[e(W,{sx:{mb:3},children:u(N,{children:[e(F,{fullWidth:!0,label:"Texte de la question",name:"questionText",value:o.questionText,onChange:y,sx:{mb:2}}),u(O,{fullWidth:!0,sx:{mb:2},children:[e(Q,{id:"level-label",children:"Niveau"}),e($,{labelId:"level-label",name:"level",value:o.level,onChange:y,children:J.map(s=>e(R,{value:s._id,children:s.name},s._id))})]}),u(O,{fullWidth:!0,sx:{mb:2},children:[e(Q,{id:"type-label",children:"Type"}),u($,{labelId:"type-label",name:"questionType",value:o.questionType,onChange:y,children:[e(R,{value:"written",children:"Écrite"}),e(R,{value:"oral",children:"Orale"})]})]}),o.questionType==="oral"&&u(q,{sx:{mb:2},children:[u(v,{onClick:()=>h==="question"?L():B("question"),variant:"contained",children:[h==="question"?e(_,{}):e(G,{})," ",h==="question"?"Stop":"Enregistrer"]}),i.question&&u(q,{mt:1,children:[e("audio",{controls:!0,src:i.question instanceof Blob?URL.createObjectURL(i.question):i.question}),e(C,{onClick:()=>M("question"),children:e(S,{})})]})]})]})}),e(D,{variant:"h6",gutterBottom:!0,children:"Réponses"}),o.answers.map((s,t)=>e(W,{sx:{mb:2},children:e(N,{children:u(f,{container:!0,spacing:2,children:[e(f,{item:!0,xs:12,sm:6,children:e(F,{fullWidth:!0,label:`Réponse ${t+1}`,value:s.text,onChange:n=>X(t,n.target.value)})}),e(f,{item:!0,xs:12,sm:2,children:e(v,{onClick:()=>Y(t),color:s.isCorrect?"success":"primary",startIcon:e(ae,{}),variant:"outlined",children:"Correcte"})}),e(f,{item:!0,xs:12,sm:2,children:o.questionType==="oral"&&e(v,{onClick:()=>h===t?L():B("answer",t),variant:"contained",children:h===t?e(_,{}):e(G,{})})}),e(f,{item:!0,xs:12,sm:2,children:e(C,{onClick:()=>ee(t),children:e(S,{})})}),o.questionType==="oral"&&i.answers[t]&&u(f,{item:!0,xs:12,children:[e("audio",{controls:!0,src:i.answers[t]instanceof Blob?URL.createObjectURL(i.answers[t]):i.answers[t]}),e(C,{onClick:()=>M("answer",t),children:e(S,{})})]})]})})},t)),e(q,{mb:2,children:e(v,{variant:"outlined",onClick:Z,disabled:o.answers.length>=4,children:"Ajouter une réponse"})}),e(v,{type:"submit",variant:"contained",disabled:E,children:E?"Mise à jour...":"Mettre à jour"})]})]})};export{ge as default};
